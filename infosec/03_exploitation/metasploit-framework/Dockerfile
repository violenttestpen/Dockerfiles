FROM alpine:latest

# Usage: docker run -it -e DATABASE_URL=postgres://postgres@db:5432/msf metasploit-framework

#COPY ./start.sh /usr/local/bin/start.sh
ENV PATH=$PATH:/usr/share/metasploit-framework 
ENV NOKOGIRI_USE_SYSTEM_LIBRARIES=1

ARG BUNDLER_ARGS="--jobs=8 --without development test coverage"
ENV MSF_USER msf
ENV NMAP_PRIVILEGED=""

#RUN chmod +x /usr/local/bin/start.sh && \
#    echo "http://nl.alpinelinux.org/alpine/v3.6/community" >> /etc/apk/repositories && \
#    echo "http://nl.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories && \
RUN apk add --update \
        ruby \
        ruby-bigdecimal \
        ruby-bundler \
#        ruby-io-console \
#        subversion \
#        sqlite \
#        libxslt \
#        postgresql \
        nmap \
        ncurses \
        # Added based on rapid7's repo
        sqlite-libs \
        nmap-scripts \
        nmap-nselibs \
        postgresql-libs \
        libpcap
        # Build Dependencies
RUN apk add --virtual .ruby-builddeps \
        autoconf \
        bison \
        build-base \
        ruby-dev \
        libressl-dev \
        readline-dev \
        sqlite-dev \
        postgresql-dev \
        libpcap-dev \
        libxml2-dev \
        libxslt-dev \
        yaml-dev \
        zlib-dev \
        ncurses-dev \
        git
#        libffi-dev\
    # Clone the MSF repository
RUN cd /usr/share \
    && git clone https://github.com/rapid7/metasploit-framework.git \
    && cd /usr/share/metasploit-framework \
    # Bundle install gem dependencies
    && echo "gem: --no-ri --no-rdoc" > /etc/gemrc \
    && bundle install --system $BUNDLER_ARGS \
    # Cleanup
RUN apk del --purge .ruby-builddeps \
    && rm -rf /var/cache/apk/* \
    # fix for robots gem not readable (known bug)
    # https://github.com/rapid7/metasploit-framework/issues/6068
    && chmod o+r /usr/local/bundle/gems/robots-*/lib/robots.rb \
    && adduser -g msfconsole -D $MSF_USER \
    # Add miscellaneous capabilities
    && /usr/sbin/setcap cap_net_raw,cap_net_bind_service=+eip $(which ruby) \
    && /usr/sbin/setcap cap_net_raw,cap_net_bind_service=+eip /usr/bin/nmap

USER $MSF_USER

VOLUME ["/usr/share/metasploit-framework"]
CMD ["/usr/share/metasploit-framework/msfconsole", "-r", "/usr/share/metasploit-framework/docker/msfconsole.rc"]
